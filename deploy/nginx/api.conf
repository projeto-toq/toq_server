# API Toq Server - Configuração Segura com CORS para Swagger
#server {
#    listen 80;
#    listen [::]:80;
#    server_name api.gca.dev.br toq-api.local;
#    # Redireciona tudo para HTTPS exceto /.well-known/acme-challenge
#    location /.well-known/acme-challenge/ { root /var/www/letsencrypt; allow all; }
#    location / { return 301 https://$host$request_uri; }
#}

server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name api.gca.dev.br toq-api.local;

    include snippets/ssl-params.conf;
    include snippets/security-headers.conf;
    http2 on;

    access_log /var/log/nginx/toq/api_access.log main_ext;
    error_log  /var/log/nginx/toq/api_error.log warn;
    proxy_buffering off;

    # Limite básico para proteção DDoS leve
    limit_req zone=req_limit_api burst=20 nodelay;

    # Health checks específicos (endpoints internos do toq_server)
    location = /healthz { 
        proxy_pass http://127.0.0.1:8080/healthz; 
        include snippets/proxy-headers.conf; 
    }
    location = /readyz  { 
        proxy_pass http://127.0.0.1:8080/readyz;  
        include snippets/proxy-headers.conf; 
    }

    # Endpoints do Swagger com CORS habilitado
    location ^~ /swagger/ {
        include snippets/proxy-headers.conf;
        proxy_pass http://127.0.0.1:8080/swagger/;
    }

    # Endpoint docs alternativo para Swagger
    location ^~ /docs/ {
        include snippets/proxy-headers.conf;
        proxy_pass http://127.0.0.1:8080/docs/;
    }

    # Endpoint auth com rate limiting específico
    location ^~ /api/v2/auth {
        include snippets/proxy-headers.conf;
        limit_req zone=api_v2_auth_limit burst=20 nodelay;
        proxy_pass http://127.0.0.1:8080/api/v2/auth;
    }

    # Todos os outros endpoints válidos da API v2 com CORS
    location ^~ /api/v2/ {
        include snippets/proxy-headers.conf;
        limit_req zone=req_limit_api burst=20 nodelay;
        proxy_pass http://127.0.0.1:8080/api/v2/;
    }

    # Bloquear tentativas de acesso a caminhos comuns de ataques
    location ~* ^/(wp-admin|wordpress|phpmyadmin|admin|\.php|\.asp|\.jsp|cgi-bin|\.env|\.git) {
        return 444; # Fechar conexão sem resposta
    }

    # Bloquear User-Agents maliciosos conhecidos
    if ($http_user_agent ~* (masscan|nmap|nikto|openvas|sqlmap|w3af|scanner)) {
        return 444;
    }

    # Bloquear métodos HTTP desnecessários
    if ($request_method !~ ^(GET|HEAD|POST|PUT|DELETE|OPTIONS)$ ) {
        return 405;
    }

    # Internal routes (added by Copilot)
    location ^~ /internal/ {
        include snippets/proxy-headers.conf;
        proxy_pass http://127.0.0.1:8080/internal/;
    }

    # Bloquear tudo o resto (requisições na raiz e caminhos inexistentes)
    location / {
        return 444; # Fechar conexão sem resposta para economizar recursos
    }
}
# Development instance proxy (ENVIRONMENT=dev)
server {
    listen 172.31.81.196:18080 ssl;
    listen [::]:18080 ssl;
    server_name api.gca.dev.br toq-api.local;

    include snippets/ssl-params.conf;
    include snippets/security-headers.conf;

    access_log /var/log/nginx/toq/api_dev_access.log main_ext;
    error_log  /var/log/nginx/toq/api_dev_error.log warn;
    proxy_buffering off;

    location = /healthz {
        proxy_pass http://127.0.0.1:18080/healthz;
        include snippets/proxy-headers.conf;
    }
    location = /readyz {
        proxy_pass http://127.0.0.1:18080/readyz;
        include snippets/proxy-headers.conf;
    }

    location ^~ /swagger/ {
        include snippets/proxy-headers.conf;
        include snippets/cors-headers.conf;
        proxy_pass http://127.0.0.1:18080/swagger/;
    }

    location ^~ /docs/ {
        include snippets/proxy-headers.conf;
        include snippets/cors-headers.conf;
        proxy_pass http://127.0.0.1:18080/docs/;
    }

    location ^~ /api/v2/auth {
        include snippets/proxy-headers.conf;
        include snippets/cors-headers.conf;
        proxy_pass http://127.0.0.1:18080/api/v2/auth;
    }

    location ^~ /api/v2/ {
        include snippets/proxy-headers.conf;
        include snippets/cors-headers.conf;
        proxy_pass http://127.0.0.1:18080/api/v2/;
    }

    location / {
        include snippets/proxy-headers.conf;
        proxy_pass http://127.0.0.1:18080$request_uri;
    }
}
