# Plano Faseado para Propaga√ß√£o de `request_id` nos Logs

| Fase | Objetivo | Principais Entregas | Depend√™ncias | Sinais de Pronto | Status |
| --- | --- | --- | --- | --- | --- |
| PR-01 ‚Äî Fundamentos de Logging Contextual | Disponibilizar utilit√°rio central que anexa `request_id`, `trace_id` e metadados padr√£o a qualquer log. | \- Novo pacote utilit√°rio (ex.: `internal/core/utils/ctxlogger`).<br>\- Ajuste m√≠nimo nas depend√™ncias para injetar `context.Context` onde necess√°rio.<br>\- Atualiza√ß√£o do guia r√°pido em `docs/toq_server_go_guide.md` destacando o uso do helper. | Nenhuma. | \- Build passa.<br>\- Smoke local confirma log com `request_id` via helper.<br>\- Documenta√ß√£o ajustada. | ‚úÖ Conclu√≠da (implementa√ß√£o local) |
| PR-02 ‚Äî Services Core | Migrar services (camada `internal/core/service/**`) para o logger contextual. | \- Substituir `slog.*` por helper contextual.<br>\- Garantir que m√©todos privados recebam `ctx` enriquecido.<br>\- Revisar fluxos de transa√ß√£o/rollback para preservar `ctx`. | PR-01. | \- `request_id` presente em logs de dom√≠nio (ex.: `auth.refresh.*`, `user.*`).<br>\- Tests existentes passam. | ‚úÖ Conclu√≠da (build + `go test ./...`) |
| PR-03-01 ‚Äî Adapters Fundacionais | Consolidar migra√ß√£o para logger contextual em adapters n√£o-MySQL (AWS S3, CEP/CPF/CNPJ, e-mail, FCM) e m√≥dulos globais do MySQL. | \- Revisar construtores e factories para propagar `ctx` enriquecido.<br>\- Atualizar helpers `internal/adapter/right/mysql/global/**` e `session/**` para usar `ContextWithLogger`.<br>\- Garantir captura de erro em spans para provedores externos. | PR-01. | \- Logs de integra√ß√µes externas exibem `request_id` e `trace_id`.<br>\- Helpers globais do MySQL sem refer√™ncias a `slog`.<br>\- `go test ./...` verde. | ‚úÖ Conclu√≠da (gofmt + `go test ./...`) |
| PR-03-02 ‚Äî MySQL Usu√°rios | Migrar adapters de usu√°rio para o logger contextual preservando spans e metadados de audit trail. | \- Refatorar `internal/adapter/right/mysql/user/**` para usar logger via `ctx`.<br>\- Ajustar conversores para receber logger via contexto quando necess√°rio.<br>\- Validar opera√ß√µes cr√≠ticas (cria√ß√£o, atualiza√ß√£o, tokens). | PR-03-01. | \- Logs de `user.*` carregam `request_id`/`trace_id` e campos de dom√≠nio.<br>\- Tests das camadas de usu√°rio passam. | ‚úÖ Conclu√≠da (gofmt + `go test ./...`) |
| PR-03-03 ‚Äî MySQL Listagens | Alinhar adapters de listagem (features, garantias, bloqueios) ao padr√£o de logger contextual. | \- Atualizar `internal/adapter/right/mysql/listing/**` com `ContextWithLogger`.<br>\- Revisar consultas paginadas para propagar spans.<br>\- Manter logs de diagn√≥stico existentes com novos campos. | PR-03-01. | \- Logs `listing.*` carregam `request_id`.<br>\- Build/testes passam. | ‚úÖ Conclu√≠da (gofmt + `go test ./...`)|
| PR-03-04 ‚Äî MySQL Complexos | Migrar adapters relacionados a complexos imobili√°rios para o novo logger. | \- Refatorar `internal/adapter/right/mysql/complex/**` para usar logger do contexto.<br>\- Atualizar conversores para reportar erros em spans.<br>\- Validar leitura multi-coluna mantendo diagn√≥sticos. | PR-03-01. | \- Logs `complex.*` exibem `request_id`.<br>\- Consultas cr√≠ticas com spans sem erros pendentes. | ‚úÖ Conclu√≠da (gofmt + `go test ./...`) |
| PR-03-05 ‚Äî MySQL Permiss√µes | Padronizar adapters de permiss√£o/RBAC com logger contextual e telemetria. | \- Atualizar `internal/adapter/right/mysql/permission/**` para usar logger e spans.<br>\- Revisar bloqueios tempor√°rios de usu√°rio e auditorias.<br>\- Garantir n√≠veis corretos (debug/warn/error). | PR-03-01. | \- Logs `permission.*` cont√™m `request_id` e campos de auditoria.<br>\- Testes de permiss√£o executados com sucesso. | ‚úÖ Conclu√≠da (gofmt + `go test ./...`)|

| PR-04 ‚Äî Handlers, Middlewares e Workers | Garantir enriquecimento consistente do contexto e ado√ß√£o do logger nas bordas. | \- Garantir uso de `EnrichContextWithRequestInfo` (ou similar) em todos os handlers.<br>\- Ajustar middlewares/rotinas ass√≠ncronas para preservar `request_id` ao spawnar goroutines.<br>\- Revisar workers para usar helper contextual. | PR-01 (e idealmente PR-02/03 para evitar conflitos). | \- Logs de handoff ass√≠ncrono (notifica√ß√µes, workers) exibem `request_id`.<br>\- Smoke test de endpoints principais mant√©m correla√ß√£o. | ‚úÖ Conclu√≠da (gofmt + `go test ./...`)|
| PR-05 ‚Äî Observabilidade e Governan√ßa | Atualizar artefatos de monitoramento e documenta√ß√£o. | \- Atualizar `docs/observability/logs.md` e dashboards Loki/Grafana com filtro `request_id`.<br>\- Registrar passos de valida√ß√£o e boas pr√°ticas no README ou doc dedicado. | PR-01 a PR-04 e PR-03-01‚Ä¶05 conclu√≠das. | \- Dashboards atualizados.<br>\- Documenta√ß√£o alinhada e revisada. | üîú Pendente |

## Notas de Execu√ß√£o
- N√£o h√° altera√ß√£o em `log.md`, conforme solicitado.
- Cada PR deve incluir resumo dos impactos e resultado dos quality gates (Build, Test, Smoke).
- PR-02: Services core (user/listing/session/validation) migrados para logger contextual, conferido com `go test ./...`.
- PR-03-02: Adapters MySQL de usu√°rio migrados para logger contextual, com `gofmt` e `go test ./...` registrando sucesso.
- PR-03-03: Listagens conclu√≠das com logger contextual e testes.
- PR-03-04: CRUD, leitores e conversores de complexos ajustados para propaga√ß√£o de spans e logger contextual; `go test ./...` executado.
- Caso surjam m√≥dulos adicionais (ex.: eventos, cache), priorizar inclus√£o na fase mais pr√≥xima do dom√≠nio (services/adapters).
- Para mitigar riscos de interrup√ß√µes, cada sub-PR deve fechar o ciclo `gofmt -> go test ./...` antes do push e atualizar este quadro.
- Se necess√°rio subdividir PRs, manter rastreabilidade aqui atualizando o quadro acima.
